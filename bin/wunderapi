#!/usr/bin/env node

var WunderAPI = require('wunderapi')

var params = process.argv.slice(2)
var options = { serial: true }

var usageMessage =
    "\n    wunderapi [-vspth] http://api.server:port/root file1 [file2 [...]]" +
    "\n      -v         Show version number" +
    "\n      -s         Run tests serially [default]" +
    "\n      -p         Run tests in parallel" +
    "\n      -h         Show this help"

while (params[0] && params[0][0] && params[0][0] == '-') { // option flag
    for (var opt = params.shift(); opt = opt.slice(1); ) {
        switch (opt[0]) {
            case 'v':
                console.log(WunderAPI.getVersion())
                break
            case 'p':
                options.serial = false
                break
            case 's':
                options.serial = true
                break
            case 'h':
                usage()
                break
            default:
                console.log("Unrecognized option: -" + opt[0])
        }
    }
}

function usage() {
    console.log(usageMessage)
    usageMessage = "\n\nPlease specify some options"
}

if (params.length < 2) {
    usage()
    process.exit()
}

options.root = params.shift()

function runNext() {
    var api = new WunderAPI(options.root)
    if (params.length < 1) return
    api.compileFile(params.shift(), function(err, vows) {
        if (err) throw(err)

        //vows.reporter = require('vows/lib/vows/reporters/spec')

        if (options.serial) {
            vows.run(null, function(err, success) {
                runNext()
            })
        } else {
            vows.run()
        }
    })
}

if (options.serial) {
    runNext() 
} else {
    while (params.length) {
        runNext()
    }
}

